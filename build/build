#!/bin/bash

# Copyright (c) 2019 FEROX YT EIRL, www.ferox.yt <devops@ferox.yt>
# Copyright (c) 2019 Jérémy WALTHER <jeremy.walther@golflima.net>
# See <https://github.com/frxyt/docker-php-dev> for details.

set -ex

# Get PHP version
FRX_PHP_VERSION=$(php -v | grep ^PHP | cut -d' ' -f2)

# Install required packages
DEBIAN_FRONTEND=noninteractive apt-get update
DEBIAN_FRONTEND=noninteractive apt-get install -y --fix-missing --no-install-recommends \
    apt-utils \
    curl \
    git \
    gnupg \
    libzip-dev \
    lynx \
    nano \
    rsync \
    sshpass \
    subversion \
    unzip \
    vim

# Install Xdebug
if [[ "${FRX_PHP_VERSION}" =~ ^7.4 ]]; then
    pecl install xdebug-beta
elif [[ "${FRX_PHP_VERSION}" =~ ^5.6 ]]; then
    pecl install xdebug-2.5.5
else
    pecl install xdebug
fi
docker-php-ext-enable xdebug
cat > /usr/local/etc/php/conf.d/zz-frx-xdebug.ini <<'EOL'
xdebug.max_nesting_level    = ${FRX_PHP_XDEBUG_MAX_NESTING_LEVEL}
xdebug.remote_autostart     = ${FRX_PHP_XDEBUG_REMOTE_AUTOSTART}
xdebug.remote_connect_back  = ${FRX_PHP_XDEBUG_REMOTE_CONNECT_BACK}
xdebug.remote_enable        = ${FRX_PHP_XDEBUG_REMOTE_ENABLE}
xdebug.remote_host          = ${FRX_PHP_XDEBUG_REMOTE_HOST}
xdebug.remote_port          = ${FRX_PHP_XDEBUG_REMOTE_PORT}
EOL

# Install XHProf
if [[ "${FRX_PHP_VERSION}" =~ ^7. ]]; then
    curl -sSL https://github.com/tideways/php-xhprof-extension/releases/download/v5.0.2/tideways-xhprof_5.0.2_amd64.deb -o tideways-xhprof_amd64.deb
    dpkg -i tideways-xhprof_amd64.deb
    apt-get install -f
    rm -f tideways-xhprof_amd64.deb
    echo "extension=/usr/lib/tideways_xhprof/tideways_xhprof-${FRX_PHP_VERSION:0:3}.so" > /usr/local/etc/php/conf.d/zz-frx-tideways-xhprof.ini
    cat >> /usr/local/etc/php/conf.d/zz-frx-tideways-xhprof.ini <<'EOL'
tideways_xhprof.clock_use_rdtsc=${FRX_PHP_TIDEWAYS_XHPROF_CLOCK_USE_RDTSC}
EOL
else
    pecl install xhprof-0.9.4
    docker-php-ext-enable xhprof
fi

# Install Composer
curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
if [[ ! "${FRX_PHP_VERSION}" =~ ^7.4 ]]; then
    docker-php-ext-configure zip --with-zlib-dir
fi
docker-php-ext-install -j$(nproc) zip
composer self-update

# Install PHPCPD
if [[ "${FRX_PHP_VERSION}" =~ ^7.[34] ]]; then
    curl -sSL https://phar.phpunit.de/phpcpd.phar -o /usr/local/bin/phpcpd
    chmod a+x /usr/local/bin/phpcpd
fi

# Install PHP CS Fixer
curl -sSL https://cs.symfony.com/download/php-cs-fixer-v2.phar -o /usr/local/bin/php-cs-fixer
chmod a+x /usr/local/bin/php-cs-fixer

# Install PHP_Depend
curl -sSL https://github.com/pdepend/pdepend/releases/download/2.6.0-beta.1/pdepend.phar -o /usr/local/bin/pdepend
chmod a+x /usr/local/bin/pdepend

# Install PHPMD
curl -sSL https://github.com/phpmd/phpmd/releases/latest/download/phpmd.phar -o /usr/local/bin/phpmd
chmod a+x /usr/local/bin/phpmd

# Install PhpMetrics
curl -sSL https://github.com/phpmetrics/PhpMetrics/releases/latest/download/phpmetrics.phar -o /usr/local/bin/phpmetrics
chmod a+x /usr/local/bin/phpmetrics

# Install PHPStan
if [[ "${FRX_PHP_VERSION}" =~ ^7.[1234] ]]; then
    curl -sSL https://github.com/phpstan/phpstan/releases/latest/download/phpstan.phar -o /usr/local/bin/phpstan
    chmod a+x /usr/local/bin/phpstan
fi

# Install PHPUnit
if [[ "${FRX_PHP_VERSION}" =~ ^5.6 ]]; then
    curl -sSL https://phar.phpunit.de/phpunit-5.phar -o /usr/local/bin/phpunit-5
    chmod a+x /usr/local/bin/phpunit-5
fi
if [[ "${FRX_PHP_VERSION}" =~ ^7. ]]; then
    curl -sSL https://phar.phpunit.de/phpunit-6.phar -o /usr/local/bin/phpunit-6
    chmod a+x /usr/local/bin/phpunit-6
fi
if [[ "${FRX_PHP_VERSION}" =~ ^7.[1234] ]]; then
    curl -sSL https://phar.phpunit.de/phpunit-7.phar -o /usr/local/bin/phpunit-7
    chmod a+x /usr/local/bin/phpunit-7
fi
if [[ "${FRX_PHP_VERSION}" =~ ^7.[234] ]]; then
    curl -sSL https://phar.phpunit.de/phpunit-8.phar -o /usr/local/bin/phpunit-8
    chmod a+x /usr/local/bin/phpunit-8
fi
cp $(ls -r1 --color=never /usr/local/bin/phpunit* | head -1) /usr/local/bin/phpunit

# Install Node.js & Yarn
curl -sL https://deb.nodesource.com/setup_10.x | bash -
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" > /etc/apt/sources.list.d/yarn.list
DEBIAN_FRONTEND=noninteractive apt-get update
DEBIAN_FRONTEND=noninteractive apt-get install -y --fix-missing --no-install-recommends \
    nodejs \
    yarn

# Enable some configuration for Apache with environment variables
if [ -f /etc/apache2/sites-enabled/000-default.conf -a -f /etc/apache2/envvars ]; then
    sed -e 's/^\s*\(DocumentRoot\)\s*.*$/\1 ${FRX_APACHE_DOCUMENT_ROOT}/' -i /etc/apache2/sites-enabled/000-default.conf
    echo -n ': ${FRX_APACHE_DOCUMENT_ROOT:=/var/www/html}\nexport FRX_APACHE_DOCUMENT_ROOT' >> /etc/apache2/envvars
fi

# Change default entrypoint
mv /usr/local/bin/docker-php-entrypoint /usr/local/bin/docker-php-entrypoint-official
ln -s /frx/start /usr/local/bin/docker-php-entrypoint

# Clean APT cache
apt-get clean -y && apt-get clean -y && apt-get autoclean -y && rm -r /var/lib/apt/lists/*
rm -rf /frx/php*

# Display versions
cat /etc/debian_version
php -v
php -m
composer -V
pdepend --version
[[ "${FRX_PHP_VERSION}" =~ ^7.[34] ]] && phpcpd --version
php-cs-fixer -V
phpmd --version
phpmetrics --version
[[ "${FRX_PHP_VERSION}" =~ ^7.[1234] ]] && phpstan --version
[[ "${FRX_PHP_VERSION}" =~ ^5.6 ]] && phpunit-5 --version
[[ "${FRX_PHP_VERSION}" =~ ^7. ]] && phpunit-6 --version
[[ "${FRX_PHP_VERSION}" =~ ^7.[1234] ]] && phpunit-7 --version
[[ "${FRX_PHP_VERSION}" =~ ^7.[234] ]] && phpunit-8 --version
phpunit --version
node -v
npm -v
yarn --version
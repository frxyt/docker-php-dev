#!/bin/bash

# Copyright (c) 2019 FEROX YT EIRL, www.ferox.yt <devops@ferox.yt>
# Copyright (c) 2019 Jérémy WALTHER <jeremy.walther@golflima.net>
# See <https://github.com/frxyt/docker-php-dev> for details.

set -ex

# Get PHP version
FRX_PHP_VERSION=$(php -v | grep ^PHP | cut -d' ' -f2)

# Install required packages
DEBIAN_FRONTEND=noninteractive apt-get update
DEBIAN_FRONTEND=noninteractive apt-get install -y --fix-missing --no-install-recommends \
    apt-utils \
    curl \
    git \
    gnupg \
    libzip-dev \
    sshpass \
    subversion \
    unzip \
    yarn

# Install Xdebug
pecl install xdebug$([[ "${FRX_PHP_VERSION}" =~ ^7.3 ]] && echo "-beta")
docker-php-ext-enable xdebug
cat > /usr/local/etc/php/php.ini <<'EOL'
xdebug.remote_connect_back=${FRX_PHP_XDEBUG_REMOTE_CONNECT_BACK}
xdebug.remote_enable=${FRX_PHP_XDEBUG_REMOTE_ENABLE}
xdebug.remote_host=${FRX_PHP_XDEBUG_REMOTE_HOST}
xdebug.remote_port${FRX_PHP_XDEBUG_REMOTE_PORT}
EOL

# Install Composer
curl -sS https://getcomposer.org/installer | php
mv composer.phar /usr/local/bin/composer
docker-php-ext-configure zip --with-zlib-dir
docker-php-ext-install -j$(nproc) zip
composer self-update

# Install Node.js
curl -sL https://deb.nodesource.com/setup_10.x | bash -
DEBIAN_FRONTEND=noninteractive apt-get upgrade -y --fix-missing --no-install-recommends \
    nodejs

# Enable some configuration for Apache with environment variables
if [ -f /etc/apache2/sites-enabled/000-default.conf -a -f /etc/apache2/envvars ]; then
    sed -e 's/^\s*\(DocumentRoot\)\s*.*$/\1 ${FRX_APACHE_DOCUMENT_ROOT}/' -i /etc/apache2/sites-enabled/000-default.conf
    echo -n ': ${FRX_APACHE_DOCUMENT_ROOT:=/var/www/html}\nexport FRX_APACHE_DOCUMENT_ROOT' >> /etc/apache2/envvars
fi

# Change default entrypoint
mv /usr/local/bin/docker-php-entrypoint /usr/local/bin/docker-php-entrypoint-official
ln -s /frx/start /usr/local/bin/docker-php-entrypoint

# Clean APT cache
apt-get clean -y && apt-get clean -y && apt-get autoclean -y && rm -r /var/lib/apt/lists/*
rm -rf /frx/php*

# Display versions
cat /etc/debian_version
php -v
php -m
composer -V
node -v
npm -v
yarn --version